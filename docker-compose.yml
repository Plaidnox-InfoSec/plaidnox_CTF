services:
  # Python Flask Backend - SQLi, SSRF
  flask-backend:
    build:
      context: ./flask-backend
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=ctf_secret_key_2024
      - NODE_SERVICE_URL=http://node-service:3000
    networks:
      - ctf-network
    volumes:
      - ./flask-backend:/app

  # Node.js Service - JWT, Code Injection
  node-service:
    build:
      context: ./node-service
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - JWT_SECRET=super_secret_jwt_key_123
      - FLASK_URL=http://flask-backend:5000
    networks:
      - ctf-network
    volumes:
      - ./node-service:/app
      - /app/node_modules

  # Nginx Proxy - Request Smuggling, Cache Poisoning
  nginx-proxy:
    build:
      context: ./nginx-proxy
      dockerfile: Dockerfile
    ports:
      - "80:80"
      - "8080:8080"
    depends_on:
      - flask-backend
      - node-service
    networks:
      - ctf-network
    volumes:
      - ./nginx-proxy/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx-proxy/cache:/var/cache/nginx

  # Frontend - XSS
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "8081:80"
    networks:
      - ctf-network

  # Mock Cloud Service (simulating AWS/Cloud metadata)
  mock-cloud:
    image: python:3.9-slim
    command: python -m http.server 8000 --directory /data
    ports:
      - "8000:8000"
    networks:
      - ctf-network
    volumes:
      - ./mock-cloud:/data

networks:
  ctf-network:
    driver: bridge
